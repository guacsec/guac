#
# Copyright 2023 The GUAC Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# NOTE: This is experimental and might change in the future!

# Defines a GraphQL schema for advanced queries over all GUAC nodes

"""
Node is a union type of all the possible nodes.

It encapsulates the software tree nodes along with the evidence nodes. In a
path query, all connecting evidence nodes along with their intermediate subject
nodes need to be returned in order to create a complete graph.
"""
union Node
  = Package
  | Source
  | Artifact
  | Builder
  | OSV
  | CVE
  | GHSA
  | NoVuln
  | IsOccurrence
  | IsDependency
  | IsVulnerability
  | CertifyVEXStatement
  | HashEqual
  | CertifyBad
  | CertifyGood
  | PkgEqual
  | CertifyScorecard
  | CertifyVuln
  | HasSourceAt
  | HasSBOM
  | HasSLSA

"""
Edge allows filtering path/neighbors output to only contain a subset of all
possible GUAC verbs.

Each member of the enum matches with one of the verbs. The naming scheme is
converting the CamelCase name to CAPITALS_WITH_UNDERSCORES.

Note that each GUAC verb is at the same time both an Edge and a Node. We need
to return it as a Node to have it show up in the return type of the queries and
we need it to be an edge to allow filtering paths to only consider certain
predicates.
"""
enum Edge {
  IS_OCCURRENCE
  IS_DEPENDENCY
  IS_VULNERABILITY
  CERTIFY_VEX_STATEMENT
  HASH_EQUAL
  CERTIFY_BAD
  CERTIFY_GOOD
  PKG_EQUAL
  CERTIFY_SCORECARD
  CERTIFY_VULN
  HAS_SOURCE_AT
  HAS_SBOM
  HAS_SLSA
}

extend type Query {
  """
  path query returns a path between subject and target, of a maximum length

  Since we want to uniquely identify endpoints, nodes must be specified by
  valid IDs only (instead of using filters/input spec structs).

  Specifying any Edge value in `usingOnly` will make the path only contain the
  corresponding GUAC evidence trees (GUAC verbs).
  """
  path(subject: ID!, target: ID!, maxPathLength: Int!, usingOnly: [Edge!]!): [Node!]!

  """
  neighbors returns all the direct neighbors of a node

  Similarly, the input is only specified by its ID.

  Specifying any Edge value in `usingOnly` will make the neighbors list only
  contain the corresponding GUAC evidence trees (GUAC verbs).
  """
  neighbors(node: ID!, usingOnly: [Edge!]!): [Node!]!

  """
  node returns a single node, regardless of type

  The input is only specified by its ID.
  """
  node(node: ID!): Node!
}
