package main

import (
	"bufio"
	"errors"
	"log"
	"os"
	"path/filepath"
	"strings"
)

var header = "Code generated by ent, DO NOT EDIT."

// Deletes all Ent generated code from a given directory.
func main() {
	if err := cmd(); err != nil {
		log.Fatalln(err)
	}
}

func cmd() error {
	path := os.Args[1]

	if path == "" {
		return errors.New("no path provided")
	}

	path, err := filepath.Abs(path)
	if err != nil {
		return err
	}
	log.Printf("Starting at %q", path)
	return enterDirectory(path)
}

func enterDirectory(path string) error {
	log.Printf("Entering %s", path)

	dir, err := os.ReadDir(path)
	if err != nil {
		return err
	}

	for _, entry := range dir {
		if err := processDirectory(path, entry); err != nil {
			return err
		}
	}

	return nil
}

func processDirectory(path string, entry os.DirEntry) error {
	if entry.IsDir() {
		return enterDirectory(filepath.Join(path, entry.Name()))
	}

	if filepath.Ext(entry.Name()) != ".go" {
		log.Printf("Skip non-go file %q", entry.Name())
		return nil
	}

	file, err := os.Open(filepath.Join(path, entry.Name()))
	if err != nil {
		return err
	}

	line, _, err := bufio.NewReader(file).ReadLine()
	if err != nil {
		return err
	}

	// Only delete files containing the "Code generated by ent, DO NOT EDIT." header.
	if strings.Contains(string(line), header) {
		log.Printf("Deleting %q", entry.Name())
		if err := os.Remove(filepath.Join(path, entry.Name())); err != nil {
			return err
		}
	}

	return nil
}
